<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Some stuff">

    <title>Domain Object Security without ACLs using Spring Security 3.2 - not1bit</title>

    <link rel="canonical" href="/2015/03/17/spring-security-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/custom.css">

    <!-- Pygments Github CSS -->
    <!--<link rel="stylesheet" href="/css/syntax.css">-->

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">not1bit</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/spring5.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Domain Object Security without ACLs using Spring Security 3.2</h1>
                    
                    <span class="meta">Posted by not1bit on March 17, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>In the <a href="/spring-security-1">previous post</a> I looked at adapting Spring Security to work with Permissions to avoid hard-coding Roles into the security configuration. Writing this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;hasAuthority(&#39;PERM_READ_FOO&#39;)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">boolean</span> <span class="nf">readFoo</span><span class="o">();</span></code></pre></div>

<p>Instead of this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;hasRole(&#39;ROLE_USER&#39;)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">boolean</span> <span class="nf">readFoo</span><span class="o">();</span></code></pre></div>

<p>Although this provides more flexibility, it is often not enough. We may need to check a users permission to access particular objects within our domain.</p>

<p>While system-wide fine grained domain object security should find us reaching for the Access Control List (ACL) schema, there are situations where an ACL approach would be overkill. </p>

<p>Spring Security is highly configurable, providing numerous hooks into its framework. Continuing with the example in my previous post, I want to show two methods of introducing domain object security that do not rely on ACLs.</p>

<p><a href="https://github.com/tony-waters/example-spring-security/tree/2-domain-object-authorisation">Source code</a> is available on GitHub.</p>

<h3 id="domain-object-security-using-a-custom-permissionevaluator">Domain object security using a Custom PermissionEvaluator</h3>

<p>One approach in Spring Security is to provide a custom <code>PermissionEvaluator</code>, which:</p>

<blockquote>
  <p>… is intended to bridge between the expression system and Spring Security’s ACL system, allowing you to specify authorization constraints on domain objects, based on abstract permissions. It has no explicit dependencies on the ACL module, <strong>so you could swap that out for an alternative implementation if required</strong>. (<a href="http://docs.spring.io/spring-security/site/docs/3.2.6.RELEASE/reference/htmlsingle/">Spring 3.2.6 Docs</a> - my emphasis)</p>
</blockquote>

<p>The <code>PermissionEvaluator</code> has the following interface:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PermissionEvaluator</span> <span class="kd">extends</span> <span class="n">AopInfrastructureBean</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="kt">boolean</span> <span class="nf">hasPermission</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">,</span> 
<span class="lineno">3</span>     		<span class="n">Object</span> <span class="n">targetDomainObject</span><span class="o">,</span> <span class="n">Object</span> <span class="n">permission</span><span class="o">);</span>
<span class="lineno">4</span>     <span class="kt">boolean</span> <span class="nf">hasPermission</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">,</span> 
<span class="lineno">5</span>     		<span class="n">Serializable</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">String</span> <span class="n">targetType</span><span class="o">,</span> <span class="n">Object</span> <span class="n">permission</span><span class="o">);</span>
<span class="lineno">6</span> <span class="o">}</span></code></pre></div>

<p>The idea is that you use the first method if you have the object itself, and the second method if you just have the ID. The methods correspond to the following expressions within our service methods (the <code>Authentication</code> parameter is automatically added by Spring):</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;hasPermission(#member, &#39;isOwner&#39;)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">void</span> <span class="nf">createMember</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">);</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;hasPermission(#id, &#39;Member&#39;, &#39;isOwner&#39;)&quot;</span><span class="o">)</span>
<span class="lineno">5</span> <span class="kt">void</span> <span class="nf">deleteMember</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">);</span></code></pre></div>

<p>By default, Spring uses a <code>DenyAllPermissionEvaluator</code>, which simply denies all requests from <code>hasPermission</code>. We will replace this with our own implementation. </p>

<p>Lets say we wanted to restrict operations on a <code>Member</code> object to just the owner of that object. Here is a simple implementation of <code>PermissionEvaluator</code> that does this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberPermissionEvaluator</span> <span class="kd">implements</span> <span class="n">PermissionEvaluator</span> <span class="o">{</span>
<span class="lineno"> 2</span> 	
<span class="lineno"> 3</span> 	<span class="nd">@Autowired</span>
<span class="lineno"> 4</span> 	<span class="kd">private</span> <span class="n">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> 	<span class="nd">@Override</span>
<span class="lineno"> 7</span> 	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermission</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">,</span> 
<span class="lineno"> 8</span> 			<span class="n">Object</span> <span class="n">targetDomainObject</span><span class="o">,</span> <span class="n">Object</span> <span class="n">permission</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span> 		<span class="kt">boolean</span> <span class="n">hasPermission</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">10</span> 		<span class="k">if</span><span class="o">(</span><span class="n">targetDomainObject</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">targetDomainObject</span> <span class="k">instanceof</span> <span class="n">Member</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">11</span> 			<span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="o">(</span><span class="n">Member</span><span class="o">)</span><span class="n">targetDomainObject</span><span class="o">;</span>
<span class="lineno">12</span> 			<span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDetails</span><span class="o">)</span><span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
<span class="lineno">13</span> 			<span class="n">hasPermission</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="lineno">14</span> 		<span class="o">}</span>
<span class="lineno">15</span> 		<span class="k">return</span> <span class="n">hasPermission</span><span class="o">;</span>
<span class="lineno">16</span> 	<span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> 	<span class="nd">@Override</span>
<span class="lineno">19</span> 	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPermission</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">,</span> <span class="n">Serializable</span> <span class="n">targetId</span><span class="o">,</span> <span class="n">String</span> <span class="n">targetType</span><span class="o">,</span> <span class="n">Object</span> <span class="n">permission</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">20</span> 		<span class="kt">boolean</span> <span class="n">hasPermission</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">21</span> 		<span class="k">if</span><span class="o">(</span><span class="n">targetId</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">targetId</span> <span class="k">instanceof</span> <span class="n">Long</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Member&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">targetType</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">22</span> 			<span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span><span class="n">targetId</span><span class="o">;</span>
<span class="lineno">23</span> 			<span class="n">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="lineno">24</span> 			<span class="k">if</span><span class="o">(</span><span class="n">member</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">25</span> 				<span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDetails</span><span class="o">)</span><span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
<span class="lineno">26</span> 				<span class="n">hasPermission</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="lineno">27</span> 			<span class="o">}</span>
<span class="lineno">28</span> 		<span class="o">}</span>
<span class="lineno">29</span> 		<span class="k">return</span> <span class="n">hasPermission</span><span class="o">;</span>
<span class="lineno">30</span> 	<span class="o">}</span>
<span class="lineno">31</span> <span class="o">}</span></code></pre></div>

<p>Now when we run our tests, a logged in user can only perform operations on its own associated <code>Member</code>.</p>

<p>Although it has not been used in this example, we could further refine our requirements by considering other permissions. As well as checking for <code>isOwner</code>, we may want to check for <code>isEditor</code>, <code>isReviewer</code>, and so on. It would not be too much work to write a better <code>PermissionEvaluator</code> to do this.</p>

<p>Also, Since Spring Security uses a single <code>PermissionEvaluator</code>, should we require similar restrictions placed on other objects (which is likely), then we would have to write a better <code>PermissionEvaluator</code> that delegated to other <code>PermissionEvaluators</code><sup><a href="#notes">[1]</a></sup>.</p>

<p>While the <code>PermissionEvaluator</code> provides a flexible hook into Spring Security, there is some boilerplate code to write if we want to deal with anything except the simplest requirements. At the other extreme, the flexibility of the <code>PermissionEvaluator</code> interface can sometimes make it appear over-general for simple domain object needs – like the example given here – leaving us having to work with unecessarily complex signitures and generic <code>Objects</code>.</p>

<p>An alternative is to use Spring’s Expression Language.</p>

<h3 id="domain-object-security-using-spring-expression-language">Domain Object security using Spring Expression Language</h3>
<p>Because the string passed into <code>@PreAuthorize</code> and <code>@PostAuthorize</code> annotations is parsed as a Spring Expression Langauge (SpEL) expression, we can write something like this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;#member.username == principal.username&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">void</span> <span class="nf">updateMember</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">);</span></code></pre></div>

<p>Where <code>#member</code> references an argument in the method signature. That is to say, it refers to the object that is passed in to the method when the security check is performed. And <code>principal</code> is the currently logged-in user. The available variables are derived from <code>SecurityExpressionRoot</code>, with others added depending on the context. In our example we also have access to the public fields and methods from <code>MethodSecurityExpressionRoot</code>. This latter class provides a <code>getReturnObject()</code> method, which allows us to write:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PostAuthorize</span><span class="o">(</span><span class="s">&quot;returnObject!=null and returnObject.username.equals(principal.username)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="n">Member</span> <span class="nf">readMember</span><span class="o">();</span></code></pre></div>

<p>This is an extremely powerful feature. We can use it to construct increasingly detailed security constraints for our application.</p>

<p>Since our security expressions could get complex, we won’t do that. Instead, lets encapsulate this into a component:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="nd">@Component</span><span class="o">(</span><span class="s">&quot;memberPermissions&quot;</span><span class="o">)</span>
<span class="lineno"> 2</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberPermissions</span> <span class="o">{</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> 	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isOwner</span><span class="o">(</span><span class="n">Member</span> <span class="n">targetDomainObject</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span> 		<span class="kt">boolean</span> <span class="n">hasPermission</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno"> 6</span> 		<span class="k">if</span><span class="o">(</span><span class="n">targetDomainObject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span> 			<span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
<span class="lineno"> 8</span> 			<span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDetails</span><span class="o">)</span><span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
<span class="lineno"> 9</span> 			<span class="n">hasPermission</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">targetDomainObject</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="lineno">10</span> 		<span class="o">}</span>
<span class="lineno">11</span> 		<span class="k">return</span> <span class="n">hasPermission</span><span class="o">;</span>
<span class="lineno">12</span> 	<span class="o">}</span>
<span class="lineno">13</span> <span class="o">}</span></code></pre></div>

<p>The Explression Language allows accessing any registered bean by preceding it with an <code>@</code> symbol<sup><a href="#notes">[2]</a></sup>. Since <code>MemberPermissions</code> is a <code>Component</code> we can access it from our method security annotations using its name, <code>memberPermissions</code>. From there we can call one of its methods, passing a <code>Member</code> object as a parameter: </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;@memberPermissions.isOwner(#member)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">void</span> <span class="nf">updateMember</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">);</span></code></pre></div>

<p>Similarly, we can use the <code>getReturnObject()</code> method from <code>MethodSecurityExpressionRoot</code> to authorise based on a methods return value:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PostAuthorize</span><span class="o">(</span><span class="s">&quot;@memberPermissions.isOwner(returnObject)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="n">Member</span> <span class="nf">readMember</span><span class="o">();</span></code></pre></div>

<p>If we want to add more permissions, we just add other methods:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="nd">@Component</span><span class="o">(</span><span class="s">&quot;memberPermissions&quot;</span><span class="o">)</span>
<span class="lineno"> 2</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberPermissions</span> <span class="o">{</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> 	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isOwner</span><span class="o">(</span><span class="n">Member</span> <span class="n">targetDomainObject</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span> 		<span class="kt">boolean</span> <span class="n">hasPermission</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno"> 6</span> 		<span class="k">if</span><span class="o">(</span><span class="n">targetDomainObject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span> 			<span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
<span class="lineno"> 8</span> 			<span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDetails</span><span class="o">)</span><span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
<span class="lineno"> 9</span> 			<span class="n">hasPermission</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">targetDomainObject</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="lineno">10</span> 		<span class="o">}</span>
<span class="lineno">11</span> 		<span class="k">return</span> <span class="n">hasPermission</span><span class="o">;</span>
<span class="lineno">12</span> 	<span class="o">}</span>
<span class="lineno">13</span> 	
<span class="lineno">14</span> 	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCollaborator</span><span class="o">(</span><span class="n">Member</span> <span class="n">targetDomainObject</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span> 	
<span class="lineno">16</span> 		<span class="c1">// ... code here ...</span>
<span class="lineno">17</span> 		
<span class="lineno">18</span> 	<span class="o">}</span>
<span class="lineno">19</span> <span class="o">}</span></code></pre></div>

<p>And if we want to work with other domain objects we can give that type its own <code>***Permissions</code> class.</p>

<p>Its hard not to like this approach. Apart from the <code>@Component</code> annotation, there is no other configuration necessary. We can use <code>MemberPermissions</code> within our security annotations straight away. This makes adding new domain object security rules straightforward. We can also easily add other methods (like <code>isEditor()</code>, <code>isReviewer()</code>) just by adding another method to <code>MemberPermissions</code>.</p>

<p>There is a great deal of flexibility here too. For example, if we so choose we can pass in in a value for the current <code>principal</code>in the authorisation annotations:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&quot;@memberPermissions.isOwner(#member, principal)&quot;</span><span class="o">)</span>
<span class="lineno">2</span> <span class="kt">void</span> <span class="nf">updateMember</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">);</span></code></pre></div>

<p>And so simplify our <code>MemberPermissions</code> code (note the automatic casting to <code>UserDetails</code>):</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isOwner</span><span class="o">(</span><span class="n">Member</span> <span class="n">targetDomainObject</span><span class="o">,</span> <span class="n">UserDetails</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">2</span> 	<span class="kt">boolean</span> <span class="n">hasPermission</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">3</span> 	<span class="k">if</span><span class="o">(</span><span class="n">targetDomainObject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">4</span> 		<span class="n">hasPermission</span> <span class="o">=</span> <span class="n">principal</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">targetDomainObject</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="lineno">5</span> 	<span class="o">}</span>
<span class="lineno">6</span> 	<span class="k">return</span> <span class="n">hasPermission</span><span class="o">;</span>
<span class="lineno">7</span> <span class="o">}</span></code></pre></div>

<p>Other nice things about this approach when compared to using a custom <code>PermissionEvaluator</code> include the lack of superfluous code, the cleaner design (we can choose to implement it as we wish), the use of <code>Member</code> explicitly rather than generic <code>Objects</code> and the corresponding automatic casting.</p>

<h3 id="and-finally-">And finally …</h3>
<p>Be aware that these expressions have changed a little over time, for example in earlier versions of Spring Security you would write the expression without the <code>@</code> symbol (see Note 2 below).</p>

<p>The source is available on <a href="https://github.com/tony-waters/example-spring-security/tree/2-domain-object-authorisation">GitHub</a>. It contains all the examples here including some basic tests. </p>
<hr />

<h2 id="a-namenotesanotes"><a name="notes"></a>Notes</h2>
<ol>
  <li>
    <p>Examples of how to do this can be seen <a href="http://blog.solidcraft.eu/2011/03/spring-security-by-example-securing.html">here</a>, <a href="http://www.disasterarea.co.uk/blog/protecting-service-methods-with-spring-security-annotations/">here</a>, and <a href="http://www.borislam.com/2012/08/writing-your-spring-security-expression.html">here</a>.</p>
  </li>
  <li>
    <p>This feature is not available in Spring Security 3.0. It is available 3.1 but you must leave out the <code>@</code> symbol. It works as shown in 3.2. See <a href="http://forum.spring.io/forum/spring-projects/security/100708-spel-and-spring-security-3-accessing-bean-reference-in-preauthorize">here</a> for discussion and a workaround for Spring Security 3.0.</p>
  </li>
</ol>

<hr />

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html">Spring Expression Language Reference</a></li>
</ul>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/03/11/spring-security-1/" data-toggle="tooltip" data-placement="top" title="Users, Roles and Permissions (unobtrusively) with Spring Security 3.2 using JPA and Java config">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
<!--                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>-->
<!--                    
                    <li>
                        <a href="https://twitter.com/SBootstrap">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    -->
<!--                    
                    <li>
                        <a href="https://www.facebook.com/IronSummitMedia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    -->
                    <li>
                        <a href="https://github.com/tony-waters">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; not1bit 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.js "></script>


</body>

</html>
