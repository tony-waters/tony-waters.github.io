<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Some stuff">

    <title>Mapping DDD Value Objects using JPA - Part 2 - not1bit</title>

    <link rel="canonical" href="/2015/02/10/value-objects-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/custom.css">

    <!-- Pygments Github CSS -->
    <!--<link rel="stylesheet" href="/css/syntax.css">-->

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">not1bit</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/java3.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Mapping DDD Value Objects using JPA - Part 2</h1>
                    
                    <span class="meta">Posted by not1bit on February 10, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<blockquote>
  <p>Tracking the identity of ENTITIES is essential, but attaching identity to other objects can hurt system performance, add analytical work, and muddle the model by making all objects look the same. (Evans 2003)</p>
</blockquote>

<p>In a <a href="/value-objects">previous post</a> I looked at the <a href="http://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> concept of Value Objects as outlined by Eric Evans (2003). In this second post I want to show how we can persist such objects to a relational database using JPA.</p>

<p>In this example I’m using H2 as the database and Hibernate as the JPA provider. It has also been tested with EclipseLink. <a href="https://github.com/tony-waters/example-value-objects">Source code</a> is available on GitHub.</p>

<h3 id="mapping-a-value-object-in-jpa-using-embeddable">Mapping a Value Object in JPA using @Embeddable</h3>
<p>The JPA Specification recognises that not everything is an Entity:</p>

<blockquote>
  <p>An entity may use other fine-grained classes to represent entity state. Instances of these classes, unlike entity instances, do not have persistent identity of their own. Instead, they exist only as part of the state of the entity to which they belong (JSR 338 - Java Persistence API 2.1)</p>
</blockquote>

<p>These <code>Embeddable</code> classes provides a convenient mapping for Value Objects. Here are the pertinent parts of the <code>Month</code> class from <a href="/value-objects">Part 1</a>, annotated as a JPA <code>Embeddable</code>:</p>

<pre><code>@Embeddable
public class Month implements Comparable&lt;Month&gt; {
	
	@Column(name="MONTH")
	private final String value;
	
	@SuppressWarnings("unused")
	private Month() {
		this.value = null;
	}

	public Month(String value) {
		if(!isValid(value)) {
			throw new DomainException("Not a valid month " + value);
		}
		this.value = value;
	}

	// ... code omitted for brevity ...
} 
</code></pre>

<p>In line with the JPA Specification, we provide a no-argument constructor. Consequently we must also provide a value for any <code>final</code> fields within this constructor. To prevent instantiation of this class without passing in a <code>value</code> we make this constructor private, and add a <code>@SuppressWarnings</code> annotation to remove the ensuing ‘never used locally’ warning.</p>

<p>This is an example of JPA making demands upon how we construct our domain classes. It is in direct opposition to DDD which encourages us to only include what is required for the domain. To use DDD Value Objects in JPA some compramises may have to be made.</p>

<p>To see <code>Month</code> in action we include it in the Entity class <code>Foo</code>:</p>

<pre><code>@Entity
@Table(name="FOO")
public class Foo {
	
	@Id
	@GeneratedValue(strategy=GenerationType.IDENTITY)
	@Column(name="ID")
	private Long entityId;
	
	@Version
	@Column(name="VERSION")
	private Integer version;

	@Column(name="BAA")
	private String baa;
	
	@Embedded
	private Month birthMonth;
	
	// ... code omitted for brevity ...
	
}
</code></pre>

<p>When we launch the application Hibernate issues the following SQL to create the table:</p>

<pre><code>create table FOO (
	ID bigint generated by default as identity,
	BAA varchar(255),
	MONTH varchar(6),
	VERSION integer,
	primary key (ID)
)
</code></pre>

<h3 id="overiding-jpa-attributes-in-value-objects">Overiding JPA Attributes in Value Objects</h3>
<p>If we wanted to use the same Value Object in two places in the same Entity, this would give us two columns with the same name, which would be invalid. Neither would this work if we wanted a different column name depending on the Entity the Value Object is embedded into. </p>

<p>JPA provides the <code>@AttributesOverride</code> annotation for this purpose. As the name suggests, it is used to override the mapping of an Entity field, to allow for a different configuration in the database table:</p>

<pre><code>@Embedded
@AttributeOverride(name = "value", column = @Column(name = "BIRTH_MONTH"))
private Month birthMonth;

@Embedded
@AttributeOverride(name = "value", column = @Column(name = "FOO_MONTH"))
private Month fooMonth;
</code></pre>

<p>Here is the new SQL produced by Hibernate:</p>

<pre><code>create table FOO (
	ID bigint generated by default as identity,
	BAA varchar(255),
	BIRTH_MONTH varchar(255),
	FOO_MONTH varchar(255),
	VERSION integer,
	primary key (ID)
)
</code></pre>

<p>The presence of <code>AttributeOverride</code> means an Entity can specify its own configuration for any <code>Embeddable</code> classes it uses. Which makes <code>Embeddables</code> re-usable across any number of Entities.</p>

<h3 id="overiding-jpa-attributes-in-composite-value-objects">Overiding JPA Attributes in Composite Value Objects</h3>
<p>In part 1 of this post I gave the  example of <code>MonthRange</code> as a composite Value Object. Here is what it looks like as an <code>Embeddable</code>:</p>

<pre><code>@Embeddable
public class MonthRange {

	@AttributeOverride(name = "value", column = @Column(name = "START_MONTH"))
	private final Month start;
	
	@AttributeOverride(name = "value", column = @Column(name = "END_MONTH"))
	private final Month end;

	@SuppressWarnings("unused")
	private MonthRange() {
		this.start = null;
		this.end = null;
	}
	
	public MonthRange(Month start, Month end) {
		if(!isValid(start, end)) {
			throw new DomainException("Not a valid month range");
		}
		this.start = start;
		this.end = end;
	}
	
	// ... code omitted for brevity ...
}
</code></pre>

<p><code>MonthRange</code> is an <code>Embeddable</code> object, which is itself composed of <code>Embeddable</code> objects. If we had two <code>MonthRange</code> fields in an Entity, that would translate to four different <code>Month</code> columns in the database.</p>

<p>To override mappings at multiple levels of embedding dot notation is used in the <code>name</code> element to specify fields within fields. </p>

<p>Here is how we override the nested column configuration for these four <code>Months</code> from within out <code>Foo</code> Entity class:</p>

<pre><code>@Entity
@Table(name="FOO")
public class Foo {
	
	// ... code omitted for brevity ...
	
	@Embedded
	@AttributeOverrides({
		@AttributeOverride(name = "start.value", column = @Column(name = "CURRENT_START_MONTH")),
		@AttributeOverride(name = "end.value", column = @Column(name = "CURRENT_END_MONTH"))
	})
	private MonthRange currentMonthRange;
	
	@Embedded
	@AttributeOverrides({
		@AttributeOverride(name = "start.value", column = @Column(name = "PREVIOUS_START_MONTH")),
		@AttributeOverride(name = "end.value", column = @Column(name = "PREVIOUS_END_MONTH"))
	})
	private MonthRange previousMonthRange;
	
	// ... code omitted for brevity ...
	
}
</code></pre>

<p>Here’s what it produces on Hibernate:</p>

<pre><code>create table FOO (
	ID bigint generated by default as identity,
	BAA varchar(255),
	BIRTH_MONTH varchar(255),
	CURRENT_END_MONTH varchar(255),
	CURRENT_START_MONTH varchar(255),
	FOO_MONTH varchar(255),
	PREVIOUS_END_MONTH varchar(255),
	PREVIOUS_START_MONTH varchar(255),
	VERSION integer,
	primary key (ID)
)
</code></pre>

<h3 id="collections-of-embeddables">Collections of Embeddables</h3>
<blockquote>
  <p>A persistent field or property of an entity or embeddable class may correspond to a collection of a basic type or embeddable class (JSR 338 - Java Persistence API 2.1)</p>
</blockquote>

<p>JPA allows for collections of <code>Embeddables</code> via its <code>ElementCollection</code> mapping. In this scenario the <code>Embeddables</code> are held in a separate table rather than being embedded in the Entities table. Similar to a <code>OneToMany</code> association, but without any requirement for inverse mapping. This is how we would add a collection of <code>Months</code> to our <code>Foo</code> Entity:</p>

<pre><code>@ElementCollection
@CollectionTable(name="FOO_MONTH", joinColumns=@JoinColumn(name="FOO_ID"))
private Collection&lt;Month&gt; months = new ArrayList&lt;Month&gt;();
</code></pre>

<p>Here’s what Hibernate does with it:</p>

<pre><code>create table FOO (
	ID bigint generated by default as identity,
	BAA varchar(255),
	BIRTH_MONTH varchar(255),
	CURRENT_END_MONTH varchar(255),
	CURRENT_START_MONTH varchar(255),
	FOO_MONTH varchar(255),
	PREVIOUS_END_MONTH varchar(255),
	PREVIOUS_START_MONTH varchar(255),
	VERSION integer,
	primary key (ID)
)

create table FOOBAA_MONTH (
	FOO_ID bigint not null,
	MONTH varchar(255)
)

alter table FOOBAA_MONTH 
	add constraint FK_f3gxv3hla3nch460sx3ss6oex 
	foreign key (FOO_ID) 
	references FOO
</code></pre>

<p>An important restriction on collections of <code>Embeddable</code> classes is that:</p>

<blockquote>
  <p>An embeddable class (including an embeddable class within another embeddable class) that is contained within an element collection must not contain an element collection</p>
</blockquote>

<p>Which means we cannot nest a collection of <code>Embeddables</code> within another collection of <code>Embeddables</code>. While this restriction may seem like an ‘edge case’, it can sometimes force us to use an Entity in place of a Value Object.</p>

<h3 id="conclusion">Conclusion</h3>
<p>In Part 1 of this post I looked at the Domain Driven Design concept of Value Objects and outlined a way of creating such an object by following Eric Evans’ advice. In this follow-up post I have tried to show how <code>Embeddables</code> provide an obvious means of mapping Value Objects to a relational database when using JPA.</p>

<p>I’ve also tried to show how producing these mappings is not always such a ‘clean’ process. Compromises have to be made between the tenents of DDD and the platform used for its implementation.</p>

<p><a href="https://github.com/tony-waters/example-value-objects">Source code</a> for the examples shown here are available on GitHub.</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/02/05/value-objects/" data-toggle="tooltip" data-placement="top" title="Mapping DDD Value Objects using JPA - Part 1">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/03/11/spring-security-1/" data-toggle="tooltip" data-placement="top" title="Users, Roles and Permissions (unobtrusively) with Spring Security 3.2 using JPA and Java config">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
<!--                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>-->
<!--                    
                    <li>
                        <a href="https://twitter.com/SBootstrap">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    -->
<!--                    
                    <li>
                        <a href="https://www.facebook.com/IronSummitMedia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    -->
                    <li>
                        <a href="https://github.com/tony-waters">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; not1bit 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.js "></script>


</body>

</html>
